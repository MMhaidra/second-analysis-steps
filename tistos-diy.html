<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: First steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">First steps in LHCb</h1>
          <h2 class="subtitle">TisTos DIY</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Learn what TisTos is and why it's useful</li>
<li>Use an interactive python session to look at TisTos on a local DST</li>
</ul>
</div>
</div>
<p>Once HLT1 or HLT2 has accepted an event, the candidates accepted by all trigger lines are saved to the raw event in a stripped-down form. One of the things that is saved are all the LHCbIDs of the final state particles of a decay tree.</p>
<div id="what-is-an-lhcbid" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="what-is-an-lhcbid" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>What is an LHCbID?</h2>
</div>
<div class="panel-body">
<p>Every single sub-detector element has an LHCbID which is unique across the whole detector. Physics objects, such as tracks, can be defined as sets of LHCbID objects. When a trigger decision is made, the set of LHCbID objects which comprise the triggering object is stored in the SelReports. This allows objects reconstructed later, such as in Brunel, to be compared with the objects reconstructed in the trigger.</p>
</div>
</div>
<p>A new feature in Run 2 is the so-called Turbo stream. Since the reconstruction available in HLT2 is the same as the offline reconstruction, physics analysis can be done with the candidates created in HLT2. If a line is configured to be a Turbo line, all information on the candidates that it selects is stored in the raw event. These candidates can be resurrected later by the Tesla application and written to a microDST. This is similar to stripping streams that go to microDST, where only candidates that are used in passing selections are available to analysts. The Turbo stream is different because information that is not saved is lost forever.</p>
<p>We will now have a look at some of the candidates stored by the HLT. We will use the script we <a href="http://lhcb.github.io/first-analysis-steps/05-interactive-dst.html">used last time</a> as a starting point, and the file <code>root://eoslhcb.cern.ch//eos/lhcb/user/r/raaij/Impactkit/00051318_00000509_1.turbo.mdst</code>. This file contains some 2016 Turbo events from <a href="http://lbrundb.cern.ch/rundb/run/174252/">run 174252</a>. Fire up your favourite editor, open the script and save a copy to work on as <code>hlt_info.py</code>. There are a few things in the script that we don't need and can be removed, such as the <code>print_decay</code> method and the decay finder tools.</p>
<p>Like the stripping, the decisions of the HLT are saved in so-called DecReports. You can find them in <code>Hlt1/DecReports</code> and <code>Hlt2/DecReports</code>, have a look at what they contain.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">evt[<span class="st">&#39;Hlt1/DecReports&#39;</span>]
evt[<span class="st">&#39;Hlt2/DecReports&#39;</span>]</code></pre></div>
<p>An important difference with the stripping is that for the HLT, all the decisions are present, even if they are false. Copy the <code>advance</code> function to <code>advance_hlt</code>, make it work on HLT decisions and make sure it really checks the decision. This can be done using the <code>decision</code> member function of a <code>DecReport</code>. Note that all names in the reports end with <code>Decision</code>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">reports <span class="op">=</span> evt[<span class="st">&#39;Hlt1/DecReports&#39;</span>]
report <span class="op">=</span> reports.decReport(<span class="st">&#39;Hlt1TrackAllL0Decision&#39;</span>)
<span class="bu">print</span> report.decision()</code></pre></div>
<p>The HLT1 selections that are most efficient for hadronic charm and beauty decays in Run 2 are called Hlt1TrackMVA and Hlt1TwoTrackMVA. Use the advance function to find an event that was accepted by either of these trigger selections.</p>
<p>The DecReports only contains the decisions for each line, 1 or 0. The candidates themselves are stored in the SelReports (&quot;Hlt{1,2}/SelReports&quot;). Get the HLT1 SelReports from the event store and retrieve the one for one of the TrackMVA selections using the selReport function, analogously to how the DecReport was retrieved above.</p>
<p>The SelReports store candidates in a tree of sub-structures, which can be accessed using the <code>substructure</code> member funtion of a report. Any SelReport has at least one level of sub-structure. The sub-structure is internally stored in SmartRefs, which can be dereferenced using their &quot;data&quot; method. Let's have a look at a SelReport for a TrackMVA selection.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">reports <span class="op">=</span> evt[<span class="st">&#39;Hlt1/SelReports&#39;</span>]
report <span class="op">=</span> reports.selReport(<span class="st">&#39;Hlt1TrackMVADecision&#39;</span>)
<span class="bu">print</span> report
report.substructure().size()
report.substructure()[<span class="dv">0</span>].substructure().size()
report.substructure()[<span class="dv">0</span>].substructure()[<span class="dv">0</span>]
report.substructure()[<span class="dv">0</span>].substructure()[<span class="dv">0</span>].data()</code></pre></div>
<p>In addition to the LHCbIDs, some numbers are also stored, such as the momentum of the track. These are stored in the numerical info dictionary that can be retrieved using:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">report.substructure()[<span class="dv">0</span>].substructure()[<span class="dv">0</span>].numericalInfo()</code></pre></div>
<div id="plot-the-transverse-momentum-distribution" class="challenge panel panel-success">
<div class="panel-heading">
<h2 id="plot-the-transverse-momentum-distribution" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Plot the transverse momentum distribution</h2>
</div>
<div class="panel-body">
<p>Make a plot of the total and transverse moment distributions of all candidates accepted by the Hlt1TrackMVA selection. Then add Hlt1TwoTrackMVA and consider the difference.</p>
</div>
</div>
<p>The LHCbIDs of the (in this case) track can be retrieved using:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">report.substructure()[<span class="dv">0</span>].substructure()[<span class="dv">0</span>].lhcbIDs()</code></pre></div>
<div id="turbo-candidates" class="challenge panel panel-success">
<div class="panel-heading">
<h2 id="turbo-candidates" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>Turbo candidates</h2>
</div>
<div class="panel-body">
<p>Now let's have a look at the same information that is stored for a candidate created by a Turbo line, for example Hlt2CharmHadDsp2KS0PimPipPip_KS0LLTurbo. Adapt the <code>advance_hlt</code> with an additional argument that allows specification of the location of <code>DecReports</code> it uses, then advance to an event that was selected by Hlt2CharmHadDsp2KS0PimPipPip_KS0LLTurbo, retrieve its <code>SelReport</code> and have a look at what's stored.</p>
</div>
</div>
<p>The LHCbIDs of the final state particles of the candidate that was created offline (in the stripping or by your script) can be compared to those saved by the HLT to find out if the offline candidate was accepted by the trigger. The classification that results from this comparison is called TisTos (Trigger independent of Signal/Trigger on Signal).</p>
<p>An offline candidate is considered to be Tos with respect to a trigger selection if it was accepted by that trigger selection. In more formal terms, if the LHCbIDs of each of the final state particles of the candidate accepted by the trigger selection overlap for more than 70% with the LHCbIDs of final state particles of the offline candidate.</p>
<p>For example, the Hlt1TrackAllL0 line accepts an event if there is at least one track with a lot of PT and a large IPCHI2. If any of the tracks accepted by the Hlt1TrackAllL0 line overlap for more than 70% with one of the tracks of the offline candidate, it is Tos with respect to Hlt1TrackAllL0. If Hlt1DiMuonHighMass is considered instead, then the LHCbIDs of both tracks that make-up the Hlt1DiMuonHighMass candidates must overlap with the LHCbIDs of two tracks that are part of the offline candidate.</p>
<p>To have a look at how this works, we'll use candidates from the D2hhPromptDst2D2RS selection, which can be retrieved thusly:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">candidates <span class="op">=</span> evt[<span class="st">&#39;AllStreams/Phys/D2hhPromptDst2D2RSLine/Particles&#39;</span>]
candidates.size()</code></pre></div>
<p>It could be that there are more than one candidates, which are unlikely to all be real. MC matching could be used to find the real one when running on simulation and on data a single candidate can be selected, either randomly or using some criterium. Dealing with multiple candidates correctly is beyond the scope of this tutorial, so just always take the first one in the container.</p>
<p>Let's use the TriggerTisTos tool now. In preparation for Run-II, the Hlt1 and Hlt2 DecReports and SelReports are now stored in different locations. That means two TisTos tools will be needed, each configured to pick up information from either HLT1 or HLT2. Since the tools we create are public tools, they have to be configured in the following way (before the AppMgr is instantiated):</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> Configurables <span class="im">import</span> ToolSvc, TriggerTisTos
ToolSvc().addTool(TriggerTisTos, <span class="st">&quot;Hlt1TriggerTisTos&quot;</span>)
ToolSvc().Hlt1TriggerTisTos.HltDecReportsLocation <span class="op">=</span> <span class="st">&#39;Hlt1/DecReports&#39;</span>
ToolSvc().Hlt1TriggerTisTos.HltSelReportsLocation <span class="op">=</span> <span class="st">&#39;Hlt1/SelReports&#39;</span></code></pre></div>
<p>Create the tools in the same way you created others during the <a href="http://lhcb.github.io/first-analysis-steps/05-interactive-dst.html">other lesson</a>, but use instance-specific names that correspond to the configuration we just added: <code>Hlt1TriggerTisTos</code> and <code>Hlt2TriggerTisTos</code>. The tools use <code>ITriggerTisTos</code> as an interface.</p>
<p>Use the advance function to find an event that has some candidates for the chosen selection and set the TisTos tools to use our candidate and trigger selection:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">hlt1TisTosTool.setOfflineInput()
candidate <span class="op">=</span> candidates[<span class="dv">0</span>]
hlt1TisTosTool.addToOfflineInput(candidate)
hlt1TisTosTool.setTriggerInput()
hlt1TisTosTool.addToTriggerInput(<span class="st">&quot;Hlt1TrackAllL0Decision&quot;</span>)
result <span class="op">=</span> hlt1TisTosTool.tisTosTobTrigger()
result.tos()</code></pre></div>
<p>The <code>set</code> calls reset the internal storage of candidate or trigger information, and the <code>addTo</code> calls then add the things we are interested in.</p>
<p>An offline candidate is considered to be Tis with respect to a trigger selection if removing it from the event would still cause the trigger selection to accept the event, i.e. if there is another particle in the event that was also accepted by the trigger selection. In more formal terms, if the LHCbIDs of the all of the final state particles of any of the candidates accepted by the trigger selection overlap less than 1% with all of the LHCbIDs of the final state particles of the offline candidate.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">result.tis()</code></pre></div>
<p>Note that a candidate can be both Tis and Tos with respect to a trigger selection, or Tos with respect to one selection, and Tis with respect to another. To tell the tool to consider more trigger selections, use the following (regexes are also supported), and try to find some events that are both Tos and Tis:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">hlt1TisTosTool.setTriggerInput()
hlt1TisTosTool.addToTriggerInput(<span class="st">&quot;Hlt1TrackAllL0Decision&quot;</span>)
hlt1TisTosTool.addToTriggerInput(<span class="st">&quot;Hlt1DiMuonHighMassDecision&quot;</span>)
result <span class="op">=</span> hlt1TisTosTool.tisTosTobTrigger()</code></pre></div>
<p>The (Tos) trigger efficiency of a trigger selection can be calculated as:</p>
<p><span class="math inline">\(\epsilon_{\mathrm{Tos}}=N_{\mathrm{Tis}\&amp;\mathrm{Tos}} / {N_{\mathrm{Tis}}}\)</span></p>
<p>Loop over the events in the DST and calculate the efficiency of Hlt1TrackAllL0. You can add some more Hlt1 selecitons when checking for Tis, which ones would make sense?</p>
<p>There is a third classification, which is called Tob. This is the case if the overlap — as defined for Tis and Tos — is between 1% and 70%.</p>
<p>To determine if a candidate is a combination of Tis, Tos and Tob or none of these, an LHCb software tool has been created that calculates the overlaps and classifies candidates with respect to trigger selection. This tool is called TriggerTisTos and it implements the ITriggerTisTos interface.</p>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/second-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
