<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: Second analysis steps</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">Second analysis steps</h1>
          <h2 class="subtitle">Scripting Ganga</h2>
<p>We have already started using Ganga, such as when <a href="https://lhcb.github.io/first-analysis-steps/davinci-grid.html">submitting jobs to the Grid</a> and <a href="https://lhcb.github.io/first-analysis-steps/ganga-data.html">using datasets from the bookkeeping</a> when creating jobs, but there's a lot more you can do with it.</p>
<p>Part of Ganga's power come from it being written in Python. When you run <code>ganga</code>, you're given an IPython prompt where you input Python code that's executed when you hit <code>&lt;enter&gt;</code>. The idea of running Python code extends outside of Ganga, where we can write scripts that Ganga will execute when starting up. This lesson will focus on writing job definition scripts, and exploring how we can define utility functions that will be available across all of our Ganga sessions.</p>
<h3 id="defining-jobs-with-scripts">Defining jobs with scripts</h3>
<p>The <code>ganga</code> executable is similar to the <code>python</code> and <code>ipython</code> executables in a couple of ways. If you just run <code>ganga</code>, your dropped into a prompt, but you can also supply the path to a Python script that will be executed. Let's start with a small script, saving it in a file called <code>create_job.py</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">greeting <span class="op">=</span> <span class="st">&#39;Hello!&#39;</span>
<span class="bu">print</span> greeting</code></pre></div>
<p>Run it:</p>
<pre class="shell"><code>$ ganga create_job.py

*** Welcome to Ganga ***
Version: 6.5.1
…
Hello!
…</code></pre>
<p>Sensible enough. Just like <code>python</code> and <code>ipython</code>, we can pass the <code>-i</code> flag before the file path to tell Ganga to give us a prompt after it's finished executing the script:</p>
<pre class="shell"><code>$ ganga -i create_job.py

*** Welcome to Ganga ***
Version: 6.5.1
…
Hello!

Ganga In [1]: greeting
Ganga Out [1]: &#39;Hello!&#39;

Ganga In [2]:</code></pre>
<p>Notice that the variable we defined in the script, <code>greeting</code>, is available in the interactive session. The idea of doing some work in a script and then manipulating the result interactively can be quite powerful.</p>
<p>One workflow that you might find useful is to create a script that defines a job, because this can often take a few lines to do, and typing them out every time is boring. Let's modify <code>create_job.py</code> to do that.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Note: Ganga makes objects like `Job` available in your script automagically</span>
j <span class="op">=</span> Job()
j.name <span class="op">=</span> <span class="st">&#39;My job&#39;</span></code></pre></div>
<p>This example is quite boring, but it captures the idea. You'll want to extend this, changing the <code>application</code> property to a <code>GaudiExec</code> instance, for example, as covered in <a href="https://lhcb.github.io/first-analysis-steps/davinci-grid.html">a previous lesson</a>.</p>
<p>Now we can run this and interact with the job as the <code>j</code> variable:</p>
<pre class="shell"><code>$ ganga -i create_job.py

*** Welcome to Ganga ***
Version: 6.5.1
…

Ganga In [1]: j
Ganga Out [1]:
Job (
  comment = ,
  parallel_submit = False,
  …
)

Ganga In [2]:</code></pre>
<p>We often want to construct a set of very similar jobs that differ only by their input data, for example running the same DaVinci application over 2015 and 2016 data and for magnet up and magnet down configurations. We need to then <em>parameterise</em> our script, and one way of doing this is passing arguments to it by the command line. You can inspect arguments from a Python script by using the <code>argv</code> property on the <code>sys</code> module:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> sys
<span class="bu">print</span> sys.argv</code></pre></div>
<p>Add that to your <code>create_job.py</code> script, and run <code>ganga</code> again, this time passing some arguments:</p>
<pre class="shell"><code>$ ganga -i create_job.py -v 123 --hello=world

*** Welcome to Ganga ***
Version: 6.5.1
…

[&#39;create_job.py&#39;, &#39;-v&#39;, &#39;123&#39;, &#39;--hello=world&#39;]

Ganga In [1]: j</code></pre>
<p>Our script sees <code>sys.argv</code> as the list of the arguments that come after <code>ganga  -i</code>. To parameterise our script for year and magnet polarity, we could check this list to find one of <code>2015</code> or <code>2016</code> and one of <code>Up</code> or <code>Down</code>, for example, but instead we'll opt to use the excellent <a href="https://docs.python.org/2/library/argparse.html"><code>argparse</code> module</a>, which comes with Python, to parse the command-line arguments for us.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> argparse

parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">&quot;Make my DaVinci job.&quot;</span>)
parser.add_argument(<span class="st">&#39;year&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, choices<span class="op">=</span>[<span class="dv">2015</span>, <span class="dv">2016</span>],
                    <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Year of data-taking to run over&#39;</span>)
parser.add_argument(<span class="st">&#39;polarity&#39;</span>, choices<span class="op">=</span>[<span class="st">&#39;Up&#39;</span>, <span class="st">&#39;Down&#39;</span>],
                    <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Polarity of data-taking to run over&#39;</span>)
parser.add_argument(<span class="st">&#39;--test&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>,
                    <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Run over one file locally&#39;</span>)
args <span class="op">=</span> parser.parse_args()

year <span class="op">=</span> args.year
polarity <span class="op">=</span> args.polarity
test <span class="op">=</span> args.test</code></pre></div>
<p>Nicely, <code>argparse</code> gives us a useful <code>--help</code> argument for free:</p>
<pre class="shell"><code>$ ganga -i create_job.py --help

*** Welcome to Ganga ***
Version: 6.5.1
…
usage: create_job.py [-h] [--test] {2015,2016} {Up,Down}

Make my DaVinci job.

positional arguments:
  {2015,2016}  Year of data-taking to run over
  {Up,Down}    Polarity of data-taking to run over

optional arguments:
  -h, --help   show this help message and exit
  --test       Run over one file locally

Ganga In [1]:</code></pre>
<p>This help will also be printed if we don't supply all of the required arguments (the year and the magnet polarity), along with a message telling us what's missing.</p>
<div id="getting-to-grips-with-argparse" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="getting-to-grips-with-argparse" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Getting to grips with <code>argparse</code></h2>
</div>
<div class="panel-body">
<p>The <code>argparse</code> module can do a lot, being able to parse complex sets of arguments with much difficultly. It's a useful tool to know in general, so we recommend that you check out the <a href="https://docs.python.org/2/library/argparse.html">documentation</a> to learn more.</p>
</div>
</div>
<p>When we do supply all the necessary arguments, the values are then available in the <code>year</code>, <code>polarity</code>, and <code>test</code> variables:</p>
<pre class="shell"><code>$ ganga -i create_job.py 2015 Down

*** Welcome to Ganga ***
Version: 6.5.1
…

Ganga In [1]: print year, polarity, test
2015 Down False</code></pre>
<p>Once you've reached this level, a whole world of possibilities opens up! Here are a few things you might proceed to do with these parameters in your script:</p>
<ul>
<li>Fetch the corresponding dataset using a <code>BKQuery</code>;</li>
<li>Give your <code>Job</code> object a specific name, e.g. <code>j.name =    'Ntuples_{0}_{1}.format(year, polarity)'</code>;</li>
<li>Give data-specific options files to the <code>application</code> object, e.g. if you have one options file per year defining <code>DaVinci().DataType</code>.</li>
</ul>
<p>Of course, you can add as many arguments as you think might be useful. Above we added the <code>--test</code> flag as an example: if this is <code>True</code>, you could run the application over only a single data file, and run the job locally rather than on the Grid (setting <code>j.backend</code> appropriately).</p>
<h3 id="adding-helpers-functions">Adding helpers functions</h3>
<p>We've seen above how giving a script to <code>ganga</code> makes the variables defined in those scripts available interactively. But what if you have, or would like to have, some set of your own custom helper methods defined in <em>every</em> session? It would be annoying to have to run <code>ganga  my_helpers.py</code> every time! Luckily, the <code>ganga.py</code> file comes to the rescue.</p>
<p>When Ganga starts, it looks for a file in your home directory (<code>echo $HOME</code>) called <code>.ganga.py</code> (note the starting period in the filename). If it finds such a file, it executes it in the context of the Ganga session, meaning the code in the file has access to Ganga objects like <code>Job</code>, <code>jobs</code>, and so on. To demonstrate the behaviour, we can put a <code>print</code> statement on our <code>~/.ganga.py</code> file:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span> <span class="st">&#39;Yo!&#39;</span></code></pre></div>
<p>Then run <code>ganga</code> (no arguments needed):</p>
<pre class="shell"><code>$ ganga

*** Welcome to Ganga ***
Version: 6.5.1
…
Yo!
…</code></pre>
<p>Neat. The general idea for this file is two-fold:</p>
<ol style="list-style-type: decimal">
<li>Add commands that you always want executed when Ganga starts, e.g. <code>print     jobs.select(status='running')</code>; and</li>
<li>Define functions for commonly-performed tasks.</li>
</ol>
<p>The latter is particularly interesting. Do you often find yourself creating a file that contains all the output LFNs of your job? Write a helper!</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> write_lfns(job, filename):
    <span class="co">&quot;&quot;&quot;Write LFNs of all DiracFiles of all completed subjobs to fname.&quot;&quot;&quot;</span>
    <span class="co"># Treat a job with subjobs the same as a job with no subjobs</span>
    jobs <span class="op">=</span> j.subjobs
    <span class="cf">if</span> <span class="bu">len</span>(jobs) <span class="op">==</span> <span class="dv">0</span>:
        jobs <span class="op">=</span> [job]

    lfns <span class="op">=</span> []
    <span class="cf">for</span> j <span class="kw">in</span> jobs:
        <span class="cf">if</span> j.status <span class="op">!=</span> <span class="st">&#39;completed&#39;</span>:
            <span class="bu">print</span> <span class="st">&#39;Skipping #</span><span class="sc">{0}</span><span class="st">&#39;</span>.<span class="bu">format</span>(j.<span class="bu">id</span>)
            <span class="cf">continue</span>
        <span class="cf">for</span> df <span class="kw">in</span> j.outputfiles.get(DiracFile):
            lfns.append(df.lfn)

    <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> f:
        f.writelfns(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(lfns))</code></pre></div>
<p>How about downloading and merging the ROOT output of a job's subjobs? Write a helper!</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> merge_root_output(job, input_tree_name, merged_filepath):
    <span class="co"># Treat a job with subjobs the same as a job with no subjobs</span>
    jobs <span class="op">=</span> j.subjobs
    <span class="cf">if</span> <span class="bu">len</span>(jobs) <span class="op">==</span> <span class="dv">0</span>:
        jobs <span class="op">=</span> [job]

    access_urls <span class="op">=</span> []
    <span class="cf">for</span> j <span class="kw">in</span> jobs:
        <span class="cf">if</span> j.status <span class="op">!=</span> <span class="st">&#39;completed&#39;</span>:
            <span class="bu">print</span> <span class="st">&#39;Skipping #</span><span class="sc">{0}</span><span class="st">&#39;</span>.<span class="bu">format</span>(j.<span class="bu">id</span>)
            <span class="cf">continue</span>
        <span class="cf">for</span> df <span class="kw">in</span> j.outputfiles.get(DiracFile):
            access_urls.append(df.accessURL())

    tchain <span class="op">=</span> ROOT.TChain(input_tree_name)
    <span class="cf">for</span> url <span class="kw">in</span> access_urls:
        tchain.Add(url)
    tchain.Merge(merged_filepath)</code></pre></div>
<p>Because of the way a <a href="https://root.cern.ch/doc/master/classTChain.html">ROOT <code>TChain</code></a> works, the subjobs output won't be downloaded, so you only need enough disk space for the merged file.</p>
<div id="using-root-in-ganga" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="using-root-in-ganga" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Using ROOT in Ganga</h2>
</div>
<div class="panel-body">
<p>By default, ROOT is not available in a Ganga session:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">Ganga In [<span class="dv">1</span>]: <span class="im">import</span> ROOT
ERROR    No module named ROOT</code></pre></div>
<p>To remedy this, you can start Ganga inside an environment where ROOT <em>is</em> available:</p>
<pre class="shell"><code>$ lb-run ROOT ganga</code></pre>
</div>
</div>
<p>Once you have your helpers defined, use them in Ganga as you would any other Python function.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">Ganga In [<span class="dv">1</span>]: j <span class="op">=</span> jobs(<span class="dv">123</span>)

Ganga In [<span class="dv">2</span>]: write_lfns(j, <span class="st">&#39;</span><span class="sc">{0}</span><span class="st">.lfns&#39;</span>.<span class="bu">format</span>(j.name))</code></pre></div>
<p>Here are some other common operations that you might want helpers for:</p>
<ul>
<li>Deleting all LFNs created by a job;</li>
<li>Resetting the <code>backend</code> of all subjobs which are marked as <code>failed</code>;</li>
<li>Replicating all LFNs to a specific Grid site.</li>
</ul>
<p>What other tasks can you think of?</p>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/second-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
